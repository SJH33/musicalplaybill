<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Booklet Viewer (Cover Right, Back Left)</title>
  <style>
    :root { --bg:#f4f5f7; --ink:#111827; --muted:#6b7280; --accent:#2563eb; --shadow:rgba(0,0,0,.14); --page-bg:#fff; }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 50% -10%,#e8ebf0 0%,var(--bg) 40%,#e5e7eb 100%);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .viewer{width:min(1200px,96vw);display:grid;grid-template-rows:auto 1fr auto;gap:14px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .leftTools{display:flex;gap:10px;align-items:center}
    .title{font-weight:700}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#e5edff;color:#1e3a8a;font-weight:700}
    .controls{display:flex;gap:8px;align-items:center}
    button{border:1px solid #d1d5db;background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    button:hover{box-shadow:0 8px 20px rgba(0,0,0,.08)}
    button:disabled{opacity:.45;cursor:not-allowed}
    input[type="file"]{display:none}
    label.fileBtn{border:1px dashed #9ca3af;background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;color:#374151}
    .stage{position:relative;width:100%;aspect-ratio:16/10;display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:clamp(8px,1.8vw,24px);background:#eef2f7;border-radius:16px;box-shadow:inset 0 0 0 1px #e5e7eb}
    .gutter{position:absolute;left:50%;top:0;bottom:0;width:2px;background:linear-gradient(to bottom,transparent,#d6dae0,transparent);transform:translateX(-1px);pointer-events:none;opacity:.7}
    .slot{position:relative;overflow:hidden;border-radius:12px;background:var(--page-bg);box-shadow:0 14px 30px var(--shadow),0 2px 5px rgba(0,0,0,.08);display:grid;place-items:center}
    .slot::before{content:"";display:block;width:100%;padding-top:calc(100%*(11/8.5))}
    .slotInner{position:absolute;inset:0;display:grid;place-items:center}
    canvas.render{max-width:100%;max-height:100%;width:100%;height:100%;object-fit:contain}
    .placeholder{font-weight:800;font-size:clamp(28px,5.5vw,64px);color:#d1d5db;user-select:none}
    .pnum{position:absolute;bottom:10px;font-size:12px;letter-spacing:.4px;color:#6b7280;background:rgba(255,255,255,.7);padding:3px 8px;border-radius:999px;box-shadow:0 1px 5px rgba(0,0,0,.08)}
    .pnum.left{left:10px}.pnum.right{right:10px}
    .hint{color:var(--muted);font-size:14px}
  </style>
  <!-- PDF.js via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // Defer viewer start until pdf.js is available
    function startWhenPdfJsReady(){
      if(typeof window.pdfjsLib === 'undefined'){ return void setTimeout(startWhenPdfJsReady, 150); }
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js';
      pdfjsLib.GlobalWorkerOptions.isEvalSupported = false; // stricter CSP friendliness
      startViewer();
    }
  </script>
</head>
<body onload="startWhenPdfJsReady()">
  <div class="wrap">
    <div class="viewer" aria-label="PDF booklet viewer">
      <div class="toolbar">
        <div class="leftTools">
          <div class="title">PDF Booklet Preview <span class="badge">Cover on Right • Back on Left</span></div>
          <label class="fileBtn" for="pdfFile">Upload PDF</label>
          <input id="pdfFile" type="file" accept="application/pdf" />
        </div>
        <div class="controls">
          <button id="prev">⟵ Prev</button>
          <div id="info" class="hint">Loading viewer…</div>
          <div id="debug" class="hint" style="font-size:12px"></div>
          <button id="next">Next ⟶</button>
        </div>
      </div>

      <div class="stage">
        <div class="gutter"></div>
        <div id="left" class="slot" aria-label="Left page">
          <div class="slotInner"><div class="placeholder">—</div></div>
          <div class="pnum left"></div>
        </div>
        <div id="right" class="slot" aria-label="Right page">
          <div class="slotInner"><div class="placeholder">—</div></div>
          <div class="pnum right"></div>
        </div>
      </div>

      <div class="hint">Tip: Use ◀ ▶ arrow keys. Cover on the <b>right</b>, back on the <b>left</b>.</div>
    </div>
  </div>

<script>
  // === Preload via your Apps Script proxy (fetch → arrayBuffer avoids XHR/CORS quirks) ===
  const PRELOAD_URL = 'https://script.google.com/macros/s/AKfycbz7DNd-xoRqcEPpL-YMk03opF_BHinZxtdPKeDY2EtYSc_VsByj9N9JAZPi7bkwHnQLIg/exec?id=1KyMl-C7EUN91OW5eeDbILWn10_uDt1Ol';

  function startViewer(){
    const info = document.getElementById('info');
    const debug = document.getElementById('debug');
    const leftSlot = document.getElementById('left');
    const rightSlot = document.getElementById('right');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');

    let pdfDoc = null, spreads = [], idx = 0;

    function makeSpreads(n){
      if(n<=0) return [];
      if(n===1) return [[null,1]];
      const s=[[null,1]]; // cover on right
      for(let p=2;p<=n-2;p+=2) s.push([p,p+1]);
      s.push([n,null]);   // back cover on left
      return s;
    }

    async function renderPage(pageNum, slot){
      // Clear slot
      slot.querySelector('.slotInner').innerHTML = '';
      const page = await pdfDoc.getPage(pageNum);
      const rect = slot.getBoundingClientRect();
      const baseVp = page.getViewport({ scale: 1 });
      const scale = (rect.width / baseVp.width) * Math.min(window.devicePixelRatio||1, 2);
      const vp = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      canvas.className = 'render';
      canvas.width = Math.floor(vp.width);
      canvas.height = Math.floor(vp.height);
      canvas.style.width = Math.floor(vp.width / (window.devicePixelRatio||1)) + 'px';
      canvas.style.height = Math.floor(vp.height / (window.devicePixelRatio||1)) + 'px';
      slot.querySelector('.slotInner').appendChild(canvas);
      await page.render({ canvasContext: canvas.getContext('2d', { alpha:false }), viewport: vp }).promise;
    }

    async function renderSpread(){
      const [L,R] = spreads[idx];
      info.textContent = `Spread ${idx+1} of ${spreads.length}`;
      prevBtn.disabled = idx===0; nextBtn.disabled = idx===spreads.length-1;
      await Promise.all([
        L ? renderPage(L, leftSlot)  : (leftSlot.querySelector('.slotInner').innerHTML = '', Promise.resolve()),
        R ? renderPage(R, rightSlot) : (rightSlot.querySelector('.slotInner').innerHTML = '', Promise.resolve()),
      ]);
    }

    async function loadPdfFromUrl(url){
      debug.textContent = 'Fetching: ' + url;
      try{
        const resp = await fetch(url, { cache: 'no-store' });
        if(!resp.ok) throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
        const buf = await resp.arrayBuffer();
        const task = pdfjsLib.getDocument({ data: buf, isEvalSupported: false });
        pdfDoc = await task.promise;
        spreads = makeSpreads(pdfDoc.numPages);
        idx = 0;
        await renderSpread();
        debug.textContent = `Loaded ${pdfDoc.numPages} pages.`;
      } catch(err){
        info.textContent = 'Failed to load PDF';
        debug.innerHTML = 'Error: ' + (err && err.message ? err.message : err) + `<br><a href="${url}" target="_blank" rel="noopener">Open source URL</a>`;
        console.error(err);
      }
    }

    // Nav
    prevBtn.addEventListener('click', ()=>{ if(idx>0){ idx--; renderSpread(); } });
    nextBtn.addEventListener('click', ()=>{ if(idx<spreads.length-1){ idx++; renderSpread(); } });
    window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') prevBtn.click(); if(e.key==='ArrowRight') nextBtn.click(); });
    rightSlot.addEventListener('click', ()=> nextBtn.click());
    leftSlot.addEventListener('click', ()=> prevBtn.click());

    // Resize
    let rTO; window.addEventListener('resize', ()=>{ clearTimeout(rTO); rTO = setTimeout(()=>{ if(pdfDoc) renderSpread(); }, 120); });

    // Kick off
    loadPdfFromUrl(PRELOAD_URL);
  }
</script>
</body>
</html>
